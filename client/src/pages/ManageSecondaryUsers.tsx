import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Users, Mail, Trash2, Plus, Loader2, AlertCircle, CheckCircle, ArrowLeft } from "lucide-react";
import { useLocation } from "wouter";
import { trpc } from "@/lib/trpc";
import { toast } from "sonner";

interface SecondaryUser {\n  id: number;\n  name: string;\n  email: string;\n  role: \"owner\" | \"secondary\";\n  addedAt: string;\n}\n\nexport default function ManageSecondaryUsers() {\n  const [, setLocation] = useLocation();\n  const [vehicleId, setVehicleId] = useState<number | null>(null);\n  const [newUserEmail, setNewUserEmail] = useState(\"\");\n  const [secondaryUsers, setSecondaryUsers] = useState<SecondaryUser[]>([]);\n  const [errors, setErrors] = useState<Record<string, string>>({});\n\n  // Mutations\n  const addSecondaryUserMutation = trpc.vehicles.addSecondaryUser.useMutation({\n    onSuccess: () => {\n      toast.success(\"Usuário adicionado com sucesso!\");\n      setNewUserEmail(\"\");\n      // Recarregar lista\n    },\n    onError: (error) => {\n      toast.error(error.message || \"Erro ao adicionar usuário\");\n      setErrors({ submit: error.message || \"Erro ao adicionar usuário\" });\n    },\n  });\n\n  const removeSecondaryUserMutation = trpc.vehicles.removeSecondaryUser.useMutation({\n    onSuccess: () => {\n      toast.success(\"Usuário removido com sucesso!\");\n      // Recarregar lista\n    },\n    onError: (error) => {\n      toast.error(error.message || \"Erro ao remover usuário\");\n    },\n  });\n\n  const validateEmail = (email: string): boolean => {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  };\n\n  const handleAddUser = (e: React.FormEvent) => {\n    e.preventDefault();\n    const newErrors: Record<string, string> = {};\n\n    if (!vehicleId) {\n      newErrors.vehicleId = \"Selecione um veículo\";\n    }\n\n    if (!newUserEmail.trim()) {\n      newErrors.email = \"Email é obrigatório\";\n    } else if (!validateEmail(newUserEmail)) {\n      newErrors.email = \"Email inválido\";\n    }\n\n    if (Object.keys(newErrors).length > 0) {\n      setErrors(newErrors);\n      return;\n    }\n\n    addSecondaryUserMutation.mutate({\n      vehicleId: vehicleId!,\n      email: newUserEmail,\n    });\n  };\n\n  const handleRemoveUser = (userId: number) => {\n    if (!vehicleId) return;\n\n    if (confirm(\"Tem certeza que deseja remover este usuário?\")) {\n      removeSecondaryUserMutation.mutate({\n        vehicleId,\n        userId,\n      });\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4\">\n      <div className=\"max-w-4xl mx-auto\">\n        {/* Header */}\n        <div className=\"flex items-center gap-3 mb-8\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => setLocation(\"/vehicles\")}\n            className=\"hover:bg-white\"\n          >\n            <ArrowLeft className=\"w-5 h-5\" />\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900\">Gerenciar Usuários</h1>\n            <p className=\"text-sm text-gray-600\">Adicione ou remova usuários secundários do seu veículo</p>\n          </div>\n        </div>\n\n        {/* Add User Card */}\n        <Card className=\"shadow-lg mb-6\">\n          <CardHeader>\n            <CardTitle>Adicionar Usuário Secundário</CardTitle>\n            <CardDescription>\n              Invite outros usuários para gerenciar este veículo\n            </CardDescription>\n          </CardHeader>\n\n          <CardContent>\n            <form onSubmit={handleAddUser} className=\"space-y-4\">\n              {/* Submit Error */}\n              {errors.submit && (\n                <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 flex gap-3\">\n                  <AlertCircle className=\"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5\" />\n                  <p className=\"text-red-700 text-sm\">{errors.submit}</p>\n                </div>\n              )}\n\n              {/* Email */}\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Mail className=\"w-4 h-4 inline mr-2\" />\n                  Email do Usuário\n                </label>\n                <Input\n                  type=\"email\"\n                  placeholder=\"usuario@example.com\"\n                  value={newUserEmail}\n                  onChange={(e) => {\n                    setNewUserEmail(e.target.value);\n                    if (errors.email) {\n                      setErrors(prev => ({ ...prev, email: \"\" }));\n                    }\n                  }}\n                  disabled={addSecondaryUserMutation.isPending}\n                  className={errors.email ? \"border-red-500\" : \"\"}\n                />\n                {errors.email && <p className=\"text-red-500 text-sm mt-1\">{errors.email}</p>}\n              </div>\n\n              {/* Info */}\n              <div className=\"bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm\">\n                <p className=\"font-semibold mb-1\">O que acontece:</p>\n                <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                  <li>O usuário receberá um convite por email</li>\n                  <li>Ele poderá aceitar e gerenciar o veículo</li>\n                  <li>Poderá enviar alertas e visualizar mensagens</li>\n                </ul>\n              </div>\n\n              {/* Submit Button */}\n              <Button\n                type=\"submit\"\n                disabled={addSecondaryUserMutation.isPending}\n                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white\"\n              >\n                {addSecondaryUserMutation.isPending ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Adicionando...\n                  </>\n                ) : (\n                  <>\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Adicionar Usuário\n                  </>\n                )}\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n\n        {/* Users List */}\n        <Card className=\"shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Users className=\"w-5 h-5\" />\n              Usuários do Veículo\n            </CardTitle>\n            <CardDescription>\n              {secondaryUsers.length} usuário(s) com acesso a este veículo\n            </CardDescription>\n          </CardHeader>\n\n          <CardContent>\n            {secondaryUsers.length === 0 ? (\n              <div className=\"text-center py-8\">\n                <Users className=\"w-12 h-12 text-gray-300 mx-auto mb-3\" />\n                <p className=\"text-gray-600\">Nenhum usuário secundário adicionado</p>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {secondaryUsers.map((user) => (\n                  <div\n                    key={user.id}\n                    className=\"flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition\"\n                  >\n                    <div>\n                      <p className=\"font-semibold text-gray-900\">{user.name}</p>\n                      <p className=\"text-sm text-gray-600\">{user.email}</p>\n                      <p className=\"text-xs text-gray-500 mt-1\">\n                        {user.role === \"owner\" ? \"Proprietário\" : \"Usuário Secundário\"} • Adicionado em {new Date(user.addedAt).toLocaleDateString()}\n                      </p>\n                    </div>\n                    {user.role !== \"owner\" && (\n                      <Button\n                        variant=\"destructive\"\n                        size=\"sm\"\n                        onClick={() => handleRemoveUser(user.id)}\n                        disabled={removeSecondaryUserMutation.isPending}\n                      >\n                        {removeSecondaryUserMutation.isPending ? (\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                        ) : (\n                          <Trash2 className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n
