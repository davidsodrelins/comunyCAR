import React, { useState, useCallback } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { AlertCircle, Trash2, Download, Pause, Play } from \"lucide-react\";\nimport { useWebSocket, useWebSocketEvent } from \"@/hooks/useWebSocket\";\nimport { format } from \"date-fns\";\n\ninterface EventLog {\n  id: string;\n  timestamp: Date;\n  event: string;\n  data: any;\n  type: \"info\" | \"success\" | \"warning\" | \"error\";\n}\n\nconst EVENT_COLORS = {\n  \"new-message\": \"bg-blue-100 text-blue-800\",\n  \"message-reaction\": \"bg-purple-100 text-purple-800\",\n  \"whatsapp-status\": \"bg-green-100 text-green-800\",\n  \"whatsapp-message-sent\": \"bg-cyan-100 text-cyan-800\",\n  \"alert-sent\": \"bg-red-100 text-red-800\",\n  \"push-notification\": \"bg-yellow-100 text-yellow-800\",\n  \"credits-updated\": \"bg-orange-100 text-orange-800\",\n  \"user-online\": \"bg-green-100 text-green-800\",\n  \"user-offline\": \"bg-gray-100 text-gray-800\",\n  \"user-typing\": \"bg-indigo-100 text-indigo-800\",\n  \"connected\": \"bg-green-100 text-green-800\",\n  \"disconnect\": \"bg-red-100 text-red-800\",\n  \"error\": \"bg-red-100 text-red-800\",\n};\n\nexport default function EventMonitor() {\n  const { isConnected } = useWebSocket();\n  const [events, setEvents] = useState<EventLog[]>([]);\n  const [isMonitoring, setIsMonitoring] = useState(true);\n  const [selectedEventTypes, setSelectedEventTypes] = useState<Set<string>>(\n    new Set()\n  );\n\n  /**\n   * Adiciona evento ao log\n   */\n  const addEvent = useCallback(\n    (event: string, data: any, type: \"info\" | \"success\" | \"warning\" | \"error\" = \"info\") => {\n      if (!isMonitoring) return;\n\n      const newEvent: EventLog = {\n        id: `${Date.now()}-${Math.random()}`,\n        timestamp: new Date(),\n        event,\n        data,\n        type,\n      };\n\n      setEvents((prev) => [newEvent, ...prev].slice(0, 100)); // Manter últimos 100 eventos\n    },\n    [isMonitoring]\n  );\n\n  /**\n   * Listeners para todos os eventos WebSocket\n   */\n  useWebSocketEvent(\"new-message\", (data) => {\n    addEvent(\"new-message\", data, \"info\");\n  });\n\n  useWebSocketEvent(\"message-reaction\", (data) => {\n    addEvent(\"message-reaction\", data, \"success\");\n  });\n\n  useWebSocketEvent(\"whatsapp-status\", (data) => {\n    addEvent(\"whatsapp-status\", data, data.status === \"connected\" ? \"success\" : \"warning\");\n  });\n\n  useWebSocketEvent(\"whatsapp-message-sent\", (data) => {\n    addEvent(\"whatsapp-message-sent\", data, \"success\");\n  });\n\n  useWebSocketEvent(\"alert-sent\", (data) => {\n    addEvent(\"alert-sent\", data, \"info\");\n  });\n\n  useWebSocketEvent(\"push-notification\", (data) => {\n    addEvent(\"push-notification\", data, \"info\");\n  });\n\n  useWebSocketEvent(\"credits-updated\", (data) => {\n    addEvent(\"credits-updated\", data, \"success\");\n  });\n\n  useWebSocketEvent(\"user-online\", (data) => {\n    addEvent(\"user-online\", data, \"success\");\n  });\n\n  useWebSocketEvent(\"user-offline\", (data) => {\n    addEvent(\"user-offline\", data, \"warning\");\n  });\n\n  useWebSocketEvent(\"user-typing\", (data) => {\n    addEvent(\"user-typing\", data, \"info\");\n  });\n\n  useWebSocketEvent(\"connected\", (data) => {\n    addEvent(\"connected\", data, \"success\");\n  });\n\n  useWebSocketEvent(\"disconnect\", (data) => {\n    addEvent(\"disconnect\", data, \"error\");\n  });\n\n  useWebSocketEvent(\"error\", (data) => {\n    addEvent(\"error\", data, \"error\");\n  });\n\n  /**\n   * Filtra eventos\n   */\n  const filteredEvents =\n    selectedEventTypes.size === 0\n      ? events\n      : events.filter((e) => selectedEventTypes.has(e.event));\n\n  /**\n   * Exporta eventos como JSON\n   */\n  const handleExport = () => {\n    const dataStr = JSON.stringify(filteredEvents, null, 2);\n    const dataBlob = new Blob([dataStr], { type: \"application/json\" });\n    const url = URL.createObjectURL(dataBlob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `eventos-${format(new Date(), \"yyyy-MM-dd-HHmmss\")}.json`;\n    link.click();\n    URL.revokeObjectURL(url);\n  };\n\n  /**\n   * Limpa logs\n   */\n  const handleClear = () => {\n    if (confirm(\"Tem certeza que deseja limpar todos os eventos?\")) {\n      setEvents([]);\n    }\n  };\n\n  /**\n   * Toggle de filtro\n   */\n  const toggleFilter = (eventType: string) => {\n    const newSelected = new Set(selectedEventTypes);\n    if (newSelected.has(eventType)) {\n      newSelected.delete(eventType);\n    } else {\n      newSelected.add(eventType);\n    }\n    setSelectedEventTypes(newSelected);\n  };\n\n  const eventTypes = Array.from(new Set(events.map((e) => e.event)));\n\n  return (\n    <div className=\"container mx-auto py-8 px-4\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Monitor de Eventos</h1>\n        <p className=\"text-gray-600\">\n          Acompanhe todos os eventos em tempo real do sistema\n        </p>\n      </div>\n\n      {/* Status e Controles */}\n      <div className=\"mb-6\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex flex-col md:flex-row items-center justify-between gap-4\">\n              <div className=\"flex items-center gap-3\">\n                <div\n                  className={`w-3 h-3 rounded-full ${\n                    isConnected ? \"bg-green-500\" : \"bg-red-500\"\n                  }`}\n                />\n                <p className=\"font-semibold\">\n                  {isConnected ? \"Conectado\" : \"Desconectado\"}\n                </p>\n                <Badge variant=\"secondary\">\n                  {filteredEvents.length} eventos\n                </Badge>\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setIsMonitoring(!isMonitoring)}\n                >\n                  {isMonitoring ? (\n                    <>\n                      <Pause className=\"w-4 h-4 mr-2\" />\n                      Pausar\n                    </>\n                  ) : (\n                    <>\n                      <Play className=\"w-4 h-4 mr-2\" />\n                      Retomar\n                    </>\n                  )}\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={handleExport}\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Exportar\n                </Button>\n                <Button\n                  variant=\"destructive\"\n                  size=\"sm\"\n                  onClick={handleClear}\n                >\n                  <Trash2 className=\"w-4 h-4 mr-2\" />\n                  Limpar\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filtros */}\n      {eventTypes.length > 0 && (\n        <div className=\"mb-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Filtrar por Tipo de Evento</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-wrap gap-2\">\n                {eventTypes.map((eventType) => (\n                  <Badge\n                    key={eventType}\n                    variant={\n                      selectedEventTypes.has(eventType) ? \"default\" : \"outline\"\n                    }\n                    className=\"cursor-pointer\"\n                    onClick={() => toggleFilter(eventType)}\n                  >\n                    {eventType}\n                  </Badge>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Log de Eventos */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Log de Eventos</CardTitle>\n          <CardDescription>\n            Últimos {filteredEvents.length} eventos\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <ScrollArea className=\"h-[600px] w-full border rounded-md p-4\">\n            {filteredEvents.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center h-full text-gray-500\">\n                <AlertCircle className=\"w-8 h-8 mb-2\" />\n                <p>Nenhum evento registrado</p>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {filteredEvents.map((event) => (\n                  <div\n                    key={event.id}\n                    className=\"border rounded-md p-3 hover:bg-gray-50 transition-colors\"\n                  >\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <Badge\n                            className={EVENT_COLORS[event.event as keyof typeof EVENT_COLORS] || \"bg-gray-100 text-gray-800\"}\n                          >\n                            {event.event}\n                          </Badge>\n                          <span className=\"text-xs text-gray-500\">\n                            {format(event.timestamp, \"HH:mm:ss.SSS\")}\n                          </span>\n                        </div>\n                        <div className=\"text-xs text-gray-600 break-words\">\n                          <pre className=\"bg-gray-100 p-2 rounded overflow-auto max-h-32\">\n                            {JSON.stringify(event.data, null, 2)}\n                          </pre>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </ScrollArea>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n
