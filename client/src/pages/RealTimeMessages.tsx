import React, { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Loader2, AlertCircle, CheckCircle, MessageCircle } from \"lucide-react\";\nimport { useWebSocket, useWebSocketEvent } from \"@/hooks/useWebSocket\";\nimport { toast } from \"sonner\";\n\ninterface RealtimeMessage {\n  id: number;\n  senderId: number;\n  senderName: string;\n  vehiclePlate: string;\n  message: string;\n  type: \"fixed\" | \"custom\";\n  timestamp: Date;\n  receivedAt: Date;\n}\n\ninterface MessageReaction {\n  messageId: number;\n  userId: number;\n  userName: string;\n  reaction: string;\n  timestamp: Date;\n}\n\ninterface WhatsAppStatus {\n  phoneNumber: string;\n  status: \"connected\" | \"disconnected\" | \"error\";\n  timestamp: Date;\n}\n\nexport default function RealTimeMessages() {\n  const { isConnected, isConnecting, error } = useWebSocket();\n  const [messages, setMessages] = useState<RealtimeMessage[]>([]);\n  const [reactions, setReactions] = useState<MessageReaction[]>([]);\n  const [whatsappStatus, setWhatsappStatus] = useState<WhatsAppStatus | null>(null);\n  const [stats, setStats] = useState({\n    totalMessages: 0,\n    totalReactions: 0,\n    whatsappConnected: false,\n  });\n\n  /**\n   * Listener: Nova mensagem recebida\n   */\n  useWebSocketEvent(\"new-message\", (data: RealtimeMessage) => {\n    console.log(\"üì® Nova mensagem recebida:\", data);\n    setMessages((prev) => [data, ...prev]);\n    setStats((prev) => ({ ...prev, totalMessages: prev.totalMessages + 1 }));\n    toast.success(`Nova mensagem de ${data.senderName}`);\n  });\n\n  /**\n   * Listener: Rea√ß√£o em mensagem\n   */\n  useWebSocketEvent(\"message-reaction\", (data: MessageReaction) => {\n    console.log(\"üëç Rea√ß√£o recebida:\", data);\n    setReactions((prev) => [data, ...prev]);\n    setStats((prev) => ({ ...prev, totalReactions: prev.totalReactions + 1 }));\n  });\n\n  /**\n   * Listener: Status do WhatsApp\n   */\n  useWebSocketEvent(\"whatsapp-status\", (data: WhatsAppStatus) => {\n    console.log(\"üì± Status WhatsApp:\", data);\n    setWhatsappStatus(data);\n    setStats((prev) => ({\n      ...prev,\n      whatsappConnected: data.status === \"connected\",\n    }));\n\n    if (data.status === \"connected\") {\n      toast.success(`WhatsApp conectado: ${data.phoneNumber}`);\n    } else if (data.status === \"disconnected\") {\n      toast.warning(`WhatsApp desconectado: ${data.phoneNumber}`);\n    } else {\n      toast.error(`Erro no WhatsApp: ${data.phoneNumber}`);\n    }\n  });\n\n  /**\n   * Listener: Mensagem WhatsApp enviada\n   */\n  useWebSocketEvent(\"whatsapp-message-sent\", (data) => {\n    console.log(\"‚úâÔ∏è Mensagem WhatsApp enviada:\", data);\n    toast.success(`Mensagem enviada para ${data.recipientPhone}`);\n  });\n\n  /**\n   * Listener: Alerta enviado\n   */\n  useWebSocketEvent(\"alert-sent\", (data) => {\n    console.log(\"üö® Alerta enviado:\", data);\n    toast.info(`Alerta enviado para placa ${data.vehiclePlate}`);\n  });\n\n  /**\n   * Listener: Notifica√ß√£o push\n   */\n  useWebSocketEvent(\"push-notification\", (data) => {\n    console.log(\"üîî Notifica√ß√£o push:\", data);\n    toast.success(data.title);\n  });\n\n  /**\n   * Listener: Cr√©ditos atualizados\n   */\n  useWebSocketEvent(\"credits-updated\", (data) => {\n    console.log(\"üí≥ Cr√©ditos atualizados:\", data);\n    toast.info(`Cr√©ditos: ${data.newBalance} (${data.reason})`);\n  });\n\n  return (\n    <div className=\"container mx-auto py-8 px-4\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Mensagens em Tempo Real</h1>\n        <p className=\"text-gray-600\">\n          Visualize mensagens, rea√ß√µes e eventos em tempo real via WebSocket\n        </p>\n      </div>\n\n      {/* Status de Conex√£o */}\n      <div className=\"mb-6\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                {isConnecting && <Loader2 className=\"w-5 h-5 animate-spin\" />}\n                {isConnected && !isConnecting && (\n                  <CheckCircle className=\"w-5 h-5 text-green-600\" />\n                )}\n                {!isConnected && !isConnecting && (\n                  <AlertCircle className=\"w-5 h-5 text-red-600\" />\n                )}\n                <div>\n                  <p className=\"font-semibold\">\n                    {isConnecting\n                      ? \"Conectando...\"\n                      : isConnected\n                      ? \"Conectado\"\n                      : \"Desconectado\"}\n                  </p>\n                  {error && <p className=\"text-sm text-red-600\">{error}</p>}\n                </div>\n              </div>\n              <Badge variant={isConnected ? \"default\" : \"secondary\"}>\n                {isConnected ? \"Online\" : \"Offline\"}\n              </Badge>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Estat√≠sticas */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <p className=\"text-3xl font-bold\">{stats.totalMessages}</p>\n              <p className=\"text-sm text-gray-600\">Mensagens Recebidas</p>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <p className=\"text-3xl font-bold\">{stats.totalReactions}</p>\n              <p className=\"text-sm text-gray-600\">Rea√ß√µes</p>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <Badge\n                variant={stats.whatsappConnected ? \"default\" : \"secondary\"}\n                className=\"text-lg\"\n              >\n                {stats.whatsappConnected ? \"WhatsApp Ativo\" : \"WhatsApp Inativo\"}\n              </Badge>\n              {whatsappStatus && (\n                <p className=\"text-xs text-gray-600 mt-2\">\n                  {whatsappStatus.phoneNumber}\n                </p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Mensagens Recebidas */}\n      <div className=\"mb-8\">\n        <h2 className=\"text-2xl font-bold mb-4\">Mensagens Recebidas</h2>\n        {messages.length === 0 ? (\n          <Alert>\n            <AlertCircle className=\"w-4 h-4\" />\n            <AlertDescription>\n              Nenhuma mensagem recebida. Aguardando novas mensagens...\n            </AlertDescription>\n          </Alert>\n        ) : (\n          <div className=\"space-y-3\">\n            {messages.slice(0, 10).map((msg) => (\n              <Card key={msg.id}>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <p className=\"font-semibold\">{msg.senderName}</p>\n                        <Badge variant={msg.type === \"fixed\" ? \"default\" : \"secondary\"}>\n                          {msg.type === \"fixed\" ? \"Alerta Fixo\" : \"Personalizado\"}\n                        </Badge>\n                      </div>\n                      <p className=\"text-sm text-gray-600 mb-2\">\n                        Placa: <span className=\"font-mono\">{msg.vehiclePlate}</span>\n                      </p>\n                      <p className=\"text-gray-800\">{msg.message}</p>\n                    </div>\n                    <div className=\"text-right ml-4\">\n                      <p className=\"text-xs text-gray-500\">\n                        {new Date(msg.timestamp).toLocaleTimeString()}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Rea√ß√µes Recentes */}\n      <div>\n        <h2 className=\"text-2xl font-bold mb-4\">Rea√ß√µes Recentes</h2>\n        {reactions.length === 0 ? (\n          <Alert>\n            <AlertCircle className=\"w-4 h-4\" />\n            <AlertDescription>\n              Nenhuma rea√ß√£o recebida ainda.\n            </AlertDescription>\n          </Alert>\n        ) : (\n          <div className=\"space-y-2\">\n            {reactions.slice(0, 10).map((reaction, idx) => (\n              <Card key={idx}>\n                <CardContent className=\"pt-4 pb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      <span className=\"text-2xl\">{reaction.reaction}</span>\n                      <div>\n                        <p className=\"font-semibold text-sm\">{reaction.userName}</p>\n                        <p className=\"text-xs text-gray-600\">\n                          Mensagem #{reaction.messageId}\n                        </p>\n                      </div>\n                    </div>\n                    <p className=\"text-xs text-gray-500\">\n                      {new Date(reaction.timestamp).toLocaleTimeString()}\n                    </p>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n
