import React, { useState, useEffect } from \"react\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Loader2, CheckCircle, AlertCircle, MessageSquare, Send } from \"lucide-react\";\nimport { toast } from \"sonner\";\n\ninterface WhatsAppSession {\n  phoneNumber: string;\n  isConnected: boolean;\n  qrCode?: string;\n  lastConnected?: Date;\n}\n\ninterface MessageStats {\n  totalMessages: number;\n  sentMessages: number;\n  failedMessages: number;\n  uniqueRecipients: number;\n  messagesWithMedia: number;\n}\n\nexport default function WhatsAppAdmin() {\n  const [sessions, setSessions] = useState<WhatsAppSession[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [selectedSession, setSelectedSession] = useState<string | null>(null);\n  const [messageText, setMessageText] = useState(\"\");\n  const [recipientPhone, setRecipientPhone] = useState(\"\");\n  const [stats, setStats] = useState<MessageStats | null>(null);\n  const [qrCode, setQrCode] = useState<string | null>(null);\n  const [showQRDialog, setShowQRDialog] = useState(false);\n\n  // Carregar sessões ativas ao montar\n  useEffect(() => {\n    loadActiveSessions();\n  }, []);\n\n  /**\n   * Carrega lista de sessões ativas\n   */\n  const loadActiveSessions = async () => {\n    setLoading(true);\n    try {\n      // Simular chamada à API\n      // const response = await trpc.whatsappAdmin.listActiveSessions.query();\n      // setSessions(response);\n      \n      // Mock data\n      setSessions([\n        {\n          phoneNumber: \"5511999999999\",\n          isConnected: true,\n          lastConnected: new Date(),\n        },\n      ]);\n    } catch (error) {\n      toast.error(\"Erro ao carregar sessões\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  /**\n   * Inicializa uma nova sessão WhatsApp\n   */\n  const handleInitializeSession = async () => {\n    if (!phoneNumber.trim()) {\n      toast.error(\"Digite um número de telefone\");\n      return;\n    }\n\n    setLoading(true);\n    try {\n      // Simular chamada à API\n      // const response = await trpc.whatsappAdmin.initializeSession.mutate({\n      //   phoneNumber,\n      // });\n\n      // Mock response\n      const mockQRCode =\n        \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==\";\n\n      setQrCode(mockQRCode);\n      setShowQRDialog(true);\n      toast.success(\"QR code gerado. Escaneie com seu WhatsApp\");\n      setPhoneNumber(\"\");\n    } catch (error) {\n      toast.error(\"Erro ao inicializar sessão\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  /**\n   * Desconecta uma sessão WhatsApp\n   */\n  const handleDisconnectSession = async (phone: string) => {\n    if (!confirm(\"Tem certeza que deseja desconectar?\")) return;\n\n    setLoading(true);\n    try {\n      // Simular chamada à API\n      // await trpc.whatsappAdmin.disconnectSession.mutate({ phoneNumber: phone });\n\n      setSessions(sessions.filter((s) => s.phoneNumber !== phone));\n      toast.success(\"Sessão desconectada com sucesso\");\n    } catch (error) {\n      toast.error(\"Erro ao desconectar sessão\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  /**\n   * Envia uma mensagem de texto\n   */\n  const handleSendMessage = async () => {\n    if (!selectedSession || !recipientPhone || !messageText) {\n      toast.error(\"Preencha todos os campos\");\n      return;\n    }\n\n    setLoading(true);\n    try {\n      // Simular chamada à API\n      // const response = await trpc.whatsappAdmin.sendTextMessage.mutate({\n      //   senderPhone: selectedSession,\n      //   recipientPhone,\n      //   message: messageText,\n      // });\n\n      toast.success(\"Mensagem enviada com sucesso\");\n      setMessageText(\"\");\n      setRecipientPhone(\"\");\n    } catch (error) {\n      toast.error(\"Erro ao enviar mensagem\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  /**\n   * Carrega estatísticas de mensagens\n   */\n  const handleLoadStats = async () => {\n    if (!selectedSession) {\n      toast.error(\"Selecione uma sessão\");\n      return;\n    }\n\n    setLoading(true);\n    try {\n      // Simular chamada à API\n      // const response = await trpc.whatsappAdmin.getMessageStats.query({\n      //   phoneNumber: selectedSession,\n      // });\n\n      // Mock data\n      setStats({\n        totalMessages: 150,\n        sentMessages: 145,\n        failedMessages: 5,\n        uniqueRecipients: 42,\n        messagesWithMedia: 28,\n      });\n    } catch (error) {\n      toast.error(\"Erro ao carregar estatísticas\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto py-8 px-4\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Painel de WhatsApp</h1>\n        <p className=\"text-gray-600\">\n          Gerenciar sessões, enviar mensagens e visualizar estatísticas\n        </p>\n      </div>\n\n      <Tabs defaultValue=\"sessions\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"sessions\">Sessões</TabsTrigger>\n          <TabsTrigger value=\"messages\">Enviar Mensagens</TabsTrigger>\n          <TabsTrigger value=\"stats\">Estatísticas</TabsTrigger>\n        </TabsList>\n\n        {/* Aba: Sessões */}\n        <TabsContent value=\"sessions\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Adicionar Nova Sessão</CardTitle>\n              <CardDescription>\n                Escaneie o QR code com seu WhatsApp\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex gap-2\">\n                <Input\n                  placeholder=\"Número de telefone (ex: 11999999999)\"\n                  value={phoneNumber}\n                  onChange={(e) => setPhoneNumber(e.target.value)}\n                />\n                <Button\n                  onClick={handleInitializeSession}\n                  disabled={loading}\n                  className=\"gap-2\"\n                >\n                  {loading && <Loader2 className=\"w-4 h-4 animate-spin\" />}\n                  Conectar\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* QR Code Dialog */}\n          <Dialog open={showQRDialog} onOpenChange={setShowQRDialog}>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Escaneie o QR Code</DialogTitle>\n                <DialogDescription>\n                  Use seu WhatsApp para escanear este QR code\n                </DialogDescription>\n              </DialogHeader>\n              {qrCode && (\n                <div className=\"flex justify-center\">\n                  <img src={qrCode} alt=\"QR Code\" className=\"w-64 h-64\" />\n                </div>\n              )}\n            </DialogContent>\n          </Dialog>\n\n          {/* Sessões Ativas */}\n          <div className=\"grid gap-4\">\n            <h3 className=\"text-lg font-semibold\">Sessões Ativas</h3>\n            {sessions.length === 0 ? (\n              <Alert>\n                <AlertCircle className=\"w-4 h-4\" />\n                <AlertDescription>\n                  Nenhuma sessão ativa. Adicione uma nova sessão acima.\n                </AlertDescription>\n              </Alert>\n            ) : (\n              sessions.map((session) => (\n                <Card key={session.phoneNumber}>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-4\">\n                        <MessageSquare className=\"w-8 h-8 text-green-600\" />\n                        <div>\n                          <p className=\"font-semibold\">{session.phoneNumber}</p>\n                          <p className=\"text-sm text-gray-600\">\n                            Último acesso:{\" \"}\n                            {session.lastConnected\n                              ? new Date(\n                                  session.lastConnected\n                                ).toLocaleString()\n                              : \"Nunca\"}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Badge\n                          variant={session.isConnected ? \"default\" : \"secondary\"}\n                        >\n                          {session.isConnected ? \"Conectado\" : \"Desconectado\"}\n                        </Badge>\n                        <Button\n                          variant=\"destructive\"\n                          size=\"sm\"\n                          onClick={() =>\n                            handleDisconnectSession(session.phoneNumber)\n                          }\n                        >\n                          Desconectar\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </div>\n        </TabsContent>\n\n        {/* Aba: Enviar Mensagens */}\n        <TabsContent value=\"messages\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Enviar Mensagem</CardTitle>\n              <CardDescription>\n                Envie mensagens de texto para contatos\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {/* Seleção de Sessão */}\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Sessão WhatsApp\n                </label>\n                <select\n                  value={selectedSession || \"\"}\n                  onChange={(e) => setSelectedSession(e.target.value)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\n                >\n                  <option value=\"\">Selecione uma sessão</option>\n                  {sessions.map((session) => (\n                    <option\n                      key={session.phoneNumber}\n                      value={session.phoneNumber}\n                    >\n                      {session.phoneNumber}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              {/* Número do Destinatário */}\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Número do Destinatário\n                </label>\n                <Input\n                  placeholder=\"Ex: 11999999999\"\n                  value={recipientPhone}\n                  onChange={(e) => setRecipientPhone(e.target.value)}\n                />\n              </div>\n\n              {/* Mensagem */}\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Mensagem\n                </label>\n                <Textarea\n                  placeholder=\"Digite sua mensagem aqui...\"\n                  value={messageText}\n                  onChange={(e) => setMessageText(e.target.value)}\n                  rows={4}\n                />\n              </div>\n\n              {/* Botão Enviar */}\n              <Button\n                onClick={handleSendMessage}\n                disabled={loading}\n                className=\"w-full gap-2\"\n              >\n                {loading && <Loader2 className=\"w-4 h-4 animate-spin\" />}\n                <Send className=\"w-4 h-4\" />\n                Enviar Mensagem\n              </Button>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Aba: Estatísticas */}\n        <TabsContent value=\"stats\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Estatísticas de Mensagens</CardTitle>\n              <CardDescription>\n                Visualize dados dos últimos 7 dias\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex gap-2 mb-4\">\n                <select\n                  value={selectedSession || \"\"}\n                  onChange={(e) => setSelectedSession(e.target.value)}\n                  className=\"flex-1 px-3 py-2 border border-gray-300 rounded-md\"\n                >\n                  <option value=\"\">Selecione uma sessão</option>\n                  {sessions.map((session) => (\n                    <option\n                      key={session.phoneNumber}\n                      value={session.phoneNumber}\n                    >\n                      {session.phoneNumber}\n                    </option>\n                  ))}\n                </select>\n                <Button\n                  onClick={handleLoadStats}\n                  disabled={loading}\n                  className=\"gap-2\"\n                >\n                  {loading && <Loader2 className=\"w-4 h-4 animate-spin\" />}\n                  Carregar\n                </Button>\n              </div>\n\n              {stats && (\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <Card>\n                    <CardContent className=\"pt-6\">\n                      <div className=\"text-center\">\n                        <p className=\"text-3xl font-bold\">\n                          {stats.totalMessages}\n                        </p>\n                        <p className=\"text-sm text-gray-600\">\n                          Total de Mensagens\n                        </p>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-6\">\n                      <div className=\"text-center\">\n                        <p className=\"text-3xl font-bold text-green-600\">\n                          {stats.sentMessages}\n                        </p>\n                        <p className=\"text-sm text-gray-600\">Enviadas</p>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-6\">\n                      <div className=\"text-center\">\n                        <p className=\"text-3xl font-bold text-red-600\">\n                          {stats.failedMessages}\n                        </p>\n                        <p className=\"text-sm text-gray-600\">Falhadas</p>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-6\">\n                      <div className=\"text-center\">\n                        <p className=\"text-3xl font-bold\">\n                          {stats.uniqueRecipients}\n                        </p>\n                        <p className=\"text-sm text-gray-600\">\n                          Contatos Únicos\n                        </p>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-6\">\n                      <div className=\"text-center\">\n                        <p className=\"text-3xl font-bold\">\n                          {stats.messagesWithMedia}\n                        </p>\n                        <p className=\"text-sm text-gray-600\">Com Mídia</p>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n
