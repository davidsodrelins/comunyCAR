import { useEffect, useRef, useCallback, useState } from \"react\";\nimport { io, Socket } from \"socket.io-client\";\nimport { useAuth } from \"./useAuth\";\n\ninterface WebSocketMessage {\n  event: string;\n  data: any;\n  timestamp: Date;\n}\n\ninterface UseWebSocketOptions {\n  autoConnect?: boolean;\n  reconnection?: boolean;\n  reconnectionDelay?: number;\n  reconnectionDelayMax?: number;\n  reconnectionAttempts?: number;\n}\n\nconst DEFAULT_OPTIONS: UseWebSocketOptions = {\n  autoConnect: true,\n  reconnection: true,\n  reconnectionDelay: 1000,\n  reconnectionDelayMax: 5000,\n  reconnectionAttempts: 10,\n};\n\nexport function useWebSocket(options: UseWebSocketOptions = {}) {\n  const { user } = useAuth();\n  const socketRef = useRef<Socket | null>(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const [isConnecting, setIsConnecting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const messageHandlersRef = useRef<Map<string, Function[]>>(new Map());\n\n  const mergedOptions = { ...DEFAULT_OPTIONS, ...options };\n\n  /**\n   * Inicializa a conex√£o WebSocket\n   */\n  const connect = useCallback(() => {\n    if (socketRef.current?.connected) {\n      return;\n    }\n\n    if (!user?.id) {\n      setError(\"Usu√°rio n√£o autenticado\");\n      return;\n    }\n\n    setIsConnecting(true);\n    setError(null);\n\n    try {\n      const socket = io(process.env.REACT_APP_WS_URL || window.location.origin, {\n        query: {\n          userId: user.id,\n        },\n        auth: {\n          token: localStorage.getItem(\"token\"),\n        },\n        reconnection: mergedOptions.reconnection,\n        reconnectionDelay: mergedOptions.reconnectionDelay,\n        reconnectionDelayMax: mergedOptions.reconnectionDelayMax,\n        reconnectionAttempts: mergedOptions.reconnectionAttempts,\n        transports: [\"websocket\", \"polling\"],\n      });\n\n      // Event: Conectado\n      socket.on(\"connected\", (data) => {\n        console.log(\"‚úÖ WebSocket conectado:\", data);\n        setIsConnected(true);\n        setIsConnecting(false);\n        setError(null);\n      });\n\n      // Event: Desconectado\n      socket.on(\"disconnect\", () => {\n        console.log(\"‚ùå WebSocket desconectado\");\n        setIsConnected(false);\n      });\n\n      // Event: Erro\n      socket.on(\"error\", (error) => {\n        console.error(\"‚ö†Ô∏è Erro WebSocket:\", error);\n        setError(error);\n      });\n\n      // Event: Reconectando\n      socket.on(\"reconnect_attempt\", () => {\n        console.log(\"üîÑ Tentando reconectar...\");\n        setIsConnecting(true);\n      });\n\n      // Event: Heartbeat\n      socket.on(\"heartbeat\", () => {\n        console.log(\"üíì Heartbeat recebido\");\n      });\n\n      socketRef.current = socket;\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : \"Erro ao conectar\";\n      setError(errorMessage);\n      setIsConnecting(false);\n    }\n  }, [user?.id, mergedOptions]);\n\n  /**\n   * Desconecta do WebSocket\n   */\n  const disconnect = useCallback(() => {\n    if (socketRef.current) {\n      socketRef.current.disconnect();\n      socketRef.current = null;\n      setIsConnected(false);\n    }\n  }, []);\n\n  /**\n   * Inscreve-se em um evento\n   */\n  const on = useCallback(\n    (event: string, handler: (data: any) => void) => {\n      if (!socketRef.current) {\n        console.warn(\"WebSocket n√£o est√° conectado\");\n        return;\n      }\n\n      socketRef.current.on(event, handler);\n\n      // Registrar handler para limpeza\n      if (!messageHandlersRef.current.has(event)) {\n        messageHandlersRef.current.set(event, []);\n      }\n      messageHandlersRef.current.get(event)!.push(handler);\n    },\n    []\n  );\n\n  /**\n   * Remove inscri√ß√£o de um evento\n   */\n  const off = useCallback((event: string, handler?: (data: any) => void) => {\n    if (!socketRef.current) return;\n\n    if (handler) {\n      socketRef.current.off(event, handler);\n    } else {\n      socketRef.current.off(event);\n    }\n  }, []);\n\n  /**\n   * Emite um evento\n   */\n  const emit = useCallback((event: string, data?: any) => {\n    if (!socketRef.current?.connected) {\n      console.warn(\"WebSocket n√£o est√° conectado\");\n      return;\n    }\n\n    socketRef.current.emit(event, data);\n  }, []);\n\n  /**\n   * Entra em uma sala\n   */\n  const joinRoom = useCallback((room: string) => {\n    emit(\"join-room\", { room });\n  }, [emit]);\n\n  /**\n   * Sai de uma sala\n   */\n  const leaveRoom = useCallback((room: string) => {\n    emit(\"leave-room\", { room });\n  }, [emit]);\n\n  /**\n   * Efeito: Conectar ao montar e desconectar ao desmontar\n   */\n  useEffect(() => {\n    if (mergedOptions.autoConnect && user?.id) {\n      connect();\n    }\n\n    return () => {\n      // Limpar handlers\n      messageHandlersRef.current.forEach((handlers) => {\n        handlers.forEach((handler) => {\n          // Handlers ser√£o removidos quando o socket for destru√≠do\n        });\n      });\n      messageHandlersRef.current.clear();\n    };\n  }, [user?.id, mergedOptions.autoConnect, connect]);\n\n  return {\n    socket: socketRef.current,\n    isConnected,\n    isConnecting,\n    error,\n    connect,\n    disconnect,\n    on,\n    off,\n    emit,\n    joinRoom,\n    leaveRoom,\n  };\n}\n\n/**\n * Hook para ouvir eventos espec√≠ficos do WebSocket\n */\nexport function useWebSocketEvent(\n  event: string,\n  handler: (data: any) => void,\n  enabled: boolean = true\n) {\n  const { on, off } = useWebSocket({ autoConnect: false });\n\n  useEffect(() => {\n    if (enabled) {\n      on(event, handler);\n\n      return () => {\n        off(event, handler);\n      };\n    }\n  }, [event, handler, enabled, on, off]);\n}\n\n/**\n * Hook para ouvir m√∫ltiplos eventos\n */\nexport function useWebSocketEvents(\n  events: Record<string, (data: any) => void>,\n  enabled: boolean = true\n) {\n  const { on, off } = useWebSocket({ autoConnect: false });\n\n  useEffect(() => {\n    if (enabled) {\n      Object.entries(events).forEach(([event, handler]) => {\n        on(event, handler);\n      });\n\n      return () => {\n        Object.entries(events).forEach(([event, handler]) => {\n          off(event, handler);\n        });\n      };\n    }\n  }, [events, enabled, on, off]);\n}\n\n/**\n * Hook para gerenciar salas\n */\nexport function useWebSocketRoom(room: string, enabled: boolean = true) {\n  const { joinRoom, leaveRoom } = useWebSocket({ autoConnect: false });\n\n  useEffect(() => {\n    if (enabled) {\n      joinRoom(room);\n\n      return () => {\n        leaveRoom(room);\n      };\n    }\n  }, [room, enabled, joinRoom, leaveRoom]);\n}\n
