import { z } from \"zod\";\nimport { router, protectedProcedure, adminProcedure } from \"../_core/trpc\";\nimport whatsappAdvancedService from \"../services/whatsapp-advanced.service\";\nimport { getDb } from \"../db\";\nimport { whatsappConfigs, whatsappMessages } from \"../../drizzle/schema\";\nimport { eq } from \"drizzle-orm\";\n\nexport const whatsappAdminRouter = router({\n  /**\n   * Inicia uma nova sessão WhatsApp e retorna QR code\n   */\n  initializeSession: adminProcedure\n    .input(\n      z.object({\n        phoneNumber: z.string().min(10, \"Número de telefone inválido\"),\n      })\n    )\n    .mutation(async ({ input }) => {\n      try {\n        const result = await whatsappAdvancedService.connectSession(\n          input.phoneNumber\n        );\n        return {\n          success: true,\n          qrCode: result.qrCode,\n          status: result.status,\n        };\n      } catch (error) {\n        return {\n          success: false,\n          error: `Erro ao inicializar sessão: ${error}`,\n        };\n      }\n    }),\n\n  /**\n   * Desconecta uma sessão WhatsApp\n   */\n  disconnectSession: adminProcedure\n    .input(\n      z.object({\n        phoneNumber: z.string(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      try {\n        await whatsappAdvancedService.disconnectSession(input.phoneNumber);\n        return {\n          success: true,\n          message: \"Sessão desconectada com sucesso\",\n        };\n      } catch (error) {\n        return {\n          success: false,\n          error: `Erro ao desconectar: ${error}`,\n        };\n      }\n    }),\n\n  /**\n   * Obtém o status de uma sessão WhatsApp\n   */\n  getSessionStatus: adminProcedure\n    .input(\n      z.object({\n        phoneNumber: z.string(),\n      })\n    )\n    .query(async ({ input }) => {\n      const session = await whatsappAdvancedService.getSessionStatus(\n        input.phoneNumber\n      );\n      return session || { error: \"Sessão não encontrada\" };\n    }),\n\n  /**\n   * Lista todas as sessões ativas\n   */\n  listActiveSessions: adminProcedure.query(async () => {\n    const sessions = await whatsappAdvancedService.listActiveSessions();\n    return sessions;\n  }),\n\n  /**\n   * Envia uma mensagem de texto via WhatsApp\n   */\n  sendTextMessage: adminProcedure\n    .input(\n      z.object({\n        senderPhone: z.string(),\n        recipientPhone: z.string(),\n        message: z.string().min(1, \"Mensagem não pode estar vazia\"),\n      })\n    )\n    .mutation(async ({ input }) => {\n      const result = await whatsappAdvancedService.sendTextMessage(\n        input.senderPhone,\n        input.recipientPhone,\n        input.message\n      );\n      return result;\n    }),\n\n  /**\n   * Envia uma mensagem com mídia\n   */\n  sendMediaMessage: adminProcedure\n    .input(\n      z.object({\n        senderPhone: z.string(),\n        recipientPhone: z.string(),\n        mediaUrl: z.string().url(),\n        caption: z.string().optional(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      const result = await whatsappAdvancedService.sendMediaMessage(\n        input.senderPhone,\n        input.recipientPhone,\n        input.mediaUrl,\n        input.caption\n      );\n      return result;\n    }),\n\n  /**\n   * Envia mensagens em massa\n   */\n  sendBulkMessages: adminProcedure\n    .input(\n      z.object({\n        senderPhone: z.string(),\n        recipients: z.array(z.string()),\n        message: z.string().min(1),\n      })\n    )\n    .mutation(async ({ input }) => {\n      const result = await whatsappAdvancedService.sendBulkMessages(\n        input.senderPhone,\n        input.recipients,\n        input.message\n      );\n      return result;\n    }),\n\n  /**\n   * Obtém histórico de mensagens\n   */\n  getMessageHistory: adminProcedure\n    .input(\n      z.object({\n        phoneNumber: z.string(),\n        limit: z.number().default(50),\n      })\n    )\n    .query(async ({ input }) => {\n      const messages = await whatsappAdvancedService.getMessageHistory(\n        input.phoneNumber,\n        input.limit\n      );\n      return messages;\n    }),\n\n  /**\n   * Obtém todas as configurações WhatsApp\n   */\n  getAllConfigs: adminProcedure.query(async () => {\n    try {\n      const db = await getDb();\n      if (!db) return [];\n\n      const configs = await db.select().from(whatsappConfigs);\n      return configs.map((config) => ({\n        phoneNumber: config.phoneNumber,\n        isActive: config.isActive,\n        lastConnected: config.lastConnected,\n        createdAt: config.createdAt,\n      }));\n    } catch (error) {\n      return [];\n    }\n  }),\n\n  /**\n   * Obtém estatísticas de mensagens\n   */\n  getMessageStats: adminProcedure\n    .input(\n      z.object({\n        phoneNumber: z.string().optional(),\n        days: z.number().default(7),\n      })\n    )\n    .query(async ({ input }) => {\n      try {\n        const db = await getDb();\n        if (!db) return null;\n\n        const sevenDaysAgo = new Date();\n        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - input.days);\n\n        let query = db\n          .select()\n          .from(whatsappMessages)\n          .where((t) => t.sentAt >= sevenDaysAgo);\n\n        if (input.phoneNumber) {\n          query = db\n            .select()\n            .from(whatsappMessages)\n            .where(\n              (t) =>\n                t.senderPhone === input.phoneNumber &&\n                t.sentAt >= sevenDaysAgo\n            );\n        }\n\n        const messages = await query;\n\n        const stats = {\n          totalMessages: messages.length,\n          sentMessages: messages.filter((m) => m.status === \"sent\").length,\n          failedMessages: messages.filter((m) => m.status === \"failed\").length,\n          uniqueRecipients: new Set(messages.map((m) => m.recipientPhone)).size,\n          messagesWithMedia: messages.filter((m) => m.mediaUrl).length,\n        };\n\n        return stats;\n      } catch (error) {\n        return null;\n      }\n    }),\n\n  /**\n   * Testa a conexão WhatsApp\n   */\n  testConnection: adminProcedure\n    .input(\n      z.object({\n        phoneNumber: z.string(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      try {\n        const session = await whatsappAdvancedService.getSessionStatus(\n          input.phoneNumber\n        );\n\n        if (!session) {\n          return {\n            success: false,\n            message: \"Sessão não encontrada\",\n          };\n        }\n\n        if (!session.isConnected) {\n          return {\n            success: false,\n            message: \"Cliente não está conectado\",\n          };\n        }\n\n        return {\n          success: true,\n          message: \"Conexão ativa e funcionando\",\n          lastConnected: session.lastConnected,\n        };\n      } catch (error) {\n        return {\n          success: false,\n          error: `Erro ao testar conexão: ${error}`,\n        };\n      }\n    }),\n});\n
