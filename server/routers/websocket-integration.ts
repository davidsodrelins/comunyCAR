import { publicProcedure, protectedProcedure, router } from \"./_core/trpc\";\nimport { getWebSocketServer } from \"../websocket/websocket.server\";\nimport { z } from \"zod\";\n\n/**\n * Router para integração de WebSocket com eventos em tempo real\n * Permite que o backend emita eventos para o frontend via WebSocket\n */\nexport const websocketIntegrationRouter = router({\n  /**\n   * Obtém estatísticas de conexão WebSocket\n   */\n  getConnectionStats: protectedProcedure.query(({ ctx }) => {\n    try {\n      const ws = getWebSocketServer();\n      return ws.getConnectionStats();\n    } catch (error) {\n      console.error(\"Erro ao obter estatísticas de conexão:\", error);\n      return {\n        totalConnectedClients: 0,\n        totalUsers: 0,\n        totalRooms: 0,\n        rooms: [],\n        timestamp: new Date(),\n      };\n    }\n  }),\n\n  /**\n   * Verifica se um usuário está online\n   */\n  isUserOnline: protectedProcedure\n    .input(z.object({ userId: z.number() }))\n    .query(({ input }) => {\n      try {\n        const ws = getWebSocketServer();\n        return {\n          isOnline: ws.isUserConnected(input.userId),\n          timestamp: new Date(),\n        };\n      } catch (error) {\n        return {\n          isOnline: false,\n          timestamp: new Date(),\n        };\n      }\n    }),\n\n  /**\n   * Obtém lista de usuários online\n   */\n  getOnlineUsers: protectedProcedure.query(({ ctx }) => {\n    try {\n      const ws = getWebSocketServer();\n      const stats = ws.getConnectionStats();\n      return {\n        totalOnline: stats.totalUsers,\n        timestamp: new Date(),\n      };\n    } catch (error) {\n      return {\n        totalOnline: 0,\n        timestamp: new Date(),\n      };\n    }\n  }),\n\n  /**\n   * Testa a conexão WebSocket\n   */\n  testConnection: protectedProcedure.mutation(({ ctx }) => {\n    try {\n      const ws = getWebSocketServer();\n      const userId = ctx.user.id;\n\n      // Emitir evento de teste para o usuário\n      ws.emitToUser(userId, \"test-connection\", {\n        message: \"Conexão WebSocket funcionando!\",\n        timestamp: new Date(),\n        userId,\n      });\n\n      return {\n        success: true,\n        message: \"Evento de teste enviado com sucesso\",\n        timestamp: new Date(),\n      };\n    } catch (error) {\n      console.error(\"Erro ao testar conexão WebSocket:\", error);\n      return {\n        success: false,\n        message: \"Erro ao enviar evento de teste\",\n        error: error instanceof Error ? error.message : \"Erro desconhecido\",\n        timestamp: new Date(),\n      };\n    }\n  }),\n});\n\n/**\n * Funções auxiliares para emitir eventos do backend\n */\n\n/**\n * Emite um evento de nova mensagem para um usuário\n */\nexport function emitNewMessage(\n  recipientUserId: number,\n  messageData: {\n    id: number;\n    senderId: number;\n    senderName: string;\n    vehiclePlate: string;\n    message: string;\n    type: \"fixed\" | \"custom\";\n    timestamp: Date;\n  }\n) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitNewMessage(recipientUserId, messageData);\n  } catch (error) {\n    console.error(\"Erro ao emitir nova mensagem:\", error);\n  }\n}\n\n/**\n * Emite um evento de reação em mensagem\n */\nexport function emitMessageReaction(\n  messageId: number,\n  reactionData: {\n    userId: number;\n    userName: string;\n    reaction: string;\n    timestamp: Date;\n  }\n) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitMessageReaction(messageId, reactionData);\n  } catch (error) {\n    console.error(\"Erro ao emitir reação:\", error);\n  }\n}\n\n/**\n * Emite um evento de status do WhatsApp\n */\nexport function emitWhatsAppStatus(\n  phoneNumber: string,\n  status: \"connected\" | \"disconnected\" | \"error\"\n) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitWhatsAppStatus(phoneNumber, status);\n  } catch (error) {\n    console.error(\"Erro ao emitir status WhatsApp:\", error);\n  }\n}\n\n/**\n * Emite um evento de mensagem WhatsApp enviada\n */\nexport function emitWhatsAppMessageSent(\n  messageData: {\n    senderPhone: string;\n    recipientPhone: string;\n    message: string;\n    messageId: string;\n    timestamp: Date;\n  }\n) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitWhatsAppMessageSent(messageData);\n  } catch (error) {\n    console.error(\"Erro ao emitir mensagem WhatsApp enviada:\", error);\n  }\n}\n\n/**\n * Emite um evento de alerta enviado\n */\nexport function emitAlertSent(\n  alertData: {\n    id: number;\n    vehicleId: number;\n    vehiclePlate: string;\n    senderId: number;\n    senderName: string;\n    type: \"fixed\" | \"custom\";\n    message: string;\n    timestamp: Date;\n  }\n) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitAlertSent(alertData);\n  } catch (error) {\n    console.error(\"Erro ao emitir alerta:\", error);\n  }\n}\n\n/**\n * Emite um evento de notificação push\n */\nexport function emitPushNotification(\n  userId: number,\n  notificationData: {\n    title: string;\n    body: string;\n    data?: any;\n    timestamp: Date;\n  }\n) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitPushNotification(userId, notificationData);\n  } catch (error) {\n    console.error(\"Erro ao emitir notificação push:\", error);\n  }\n}\n\n/**\n * Emite um evento de créditos atualizados\n */\nexport function emitCreditsUpdated(\n  userId: number,\n  creditsData: {\n    newBalance: number;\n    change: number;\n    reason: string;\n    timestamp: Date;\n  }\n) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitCreditsUpdated(userId, creditsData);\n  } catch (error) {\n    console.error(\"Erro ao emitir créditos atualizados:\", error);\n  }\n}\n\n/**\n * Emite um evento de usuário online\n */\nexport function emitUserOnline(userId: number) {\n  try {\n    const ws = getWebSocketServer();\n    ws.broadcast(\"user-online\", {\n      userId,\n      timestamp: new Date(),\n    });\n  } catch (error) {\n    console.error(\"Erro ao emitir usuário online:\", error);\n  }\n}\n\n/**\n * Emite um evento de usuário offline\n */\nexport function emitUserOffline(userId: number) {\n  try {\n    const ws = getWebSocketServer();\n    ws.broadcast(\"user-offline\", {\n      userId,\n      timestamp: new Date(),\n    });\n  } catch (error) {\n    console.error(\"Erro ao emitir usuário offline:\", error);\n  }\n}\n\n/**\n * Emite um evento de digitação\n */\nexport function emitUserTyping(userId: number, room: string) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitToRoom(room, \"user-typing\", {\n      userId,\n      timestamp: new Date(),\n    });\n  } catch (error) {\n    console.error(\"Erro ao emitir digitação:\", error);\n  }\n}\n\n/**\n * Emite um evento de parada de digitação\n */\nexport function emitUserStoppedTyping(userId: number, room: string) {\n  try {\n    const ws = getWebSocketServer();\n    ws.emitToRoom(room, \"user-stopped-typing\", {\n      userId,\n      timestamp: new Date(),\n    });\n  } catch (error) {\n    console.error(\"Erro ao emitir parada de digitação:\", error);\n  }\n}\n
