import { Server as SocketIOServer, Socket } from \"socket.io\";\nimport { Server as HTTPServer } from \"http\";\nimport { Logger } from \"../utils/logger\";\n\ninterface UserSocket {\n  userId: number;\n  socketId: string;\n  connectedAt: Date;\n  lastActivity: Date;\n}\n\ninterface RoomInfo {\n  name: string;\n  members: Set<string>;\n  createdAt: Date;\n}\n\nexport class WebSocketServer {\n  private io: SocketIOServer;\n  private userSockets: Map<number, Set<string>> = new Map();\n  private socketUsers: Map<string, number> = new Map();\n  private rooms: Map<string, RoomInfo> = new Map();\n  private heartbeatInterval: NodeJS.Timeout;\n  private readonly logger = new Logger(\"WebSocketServer\");\n\n  constructor(httpServer: HTTPServer) {\n    this.io = new SocketIOServer(httpServer, {\n      cors: {\n        origin: process.env.FRONTEND_URL || \"*\",\n        methods: [\"GET\", \"POST\"],\n        credentials: true,\n      },\n      transports: [\"websocket\", \"polling\"],\n      pingInterval: 30000,\n      pingTimeout: 10000,\n    });\n\n    this.setupMiddleware();\n    this.setupEventHandlers();\n    this.startHeartbeat();\n\n    this.logger.info(\"ðŸš€ WebSocket Server inicializado\");\n  }\n\n  /**\n   * Configura middlewares de autenticaÃ§Ã£o\n   */\n  private setupMiddleware() {\n    this.io.use((socket, next) => {\n      const userId = socket.handshake.query.userId as string;\n      const token = socket.handshake.auth.token as string;\n\n      if (!userId) {\n        return next(new Error(\"userId Ã© obrigatÃ³rio\"));\n      }\n\n      // Aqui vocÃª pode adicionar validaÃ§Ã£o de token JWT\n      // if (!this.validateToken(token)) {\n      //   return next(new Error('Token invÃ¡lido'));\n      // }\n\n      socket.data.userId = parseInt(userId);\n      next();\n    });\n  }\n\n  /**\n   * Configura handlers de eventos\n   */\n  private setupEventHandlers() {\n    this.io.on(\"connection\", (socket: Socket) => {\n      const userId = socket.data.userId as number;\n      this.logger.info(`âœ… Cliente conectado: ${socket.id} (usuÃ¡rio: ${userId})`);\n\n      // Registrar socket do usuÃ¡rio\n      if (!this.userSockets.has(userId)) {\n        this.userSockets.set(userId, new Set());\n      }\n      this.userSockets.get(userId)!.add(socket.id);\n      this.socketUsers.set(socket.id, userId);\n\n      // Enviar confirmaÃ§Ã£o de conexÃ£o\n      socket.emit(\"connected\", {\n        message: \"Conectado ao servidor WebSocket\",\n        clientId: socket.id,\n        userId,\n        timestamp: new Date(),\n      });\n\n      // Entrar na sala do usuÃ¡rio\n      const userRoom = `user-${userId}`;\n      socket.join(userRoom);\n      this.logger.info(`ðŸ‘¤ Cliente ${socket.id} entrou na sala ${userRoom}`);\n\n      // Handlers de eventos\n      socket.on(\"join-room\", (data) => this.handleJoinRoom(socket, data));\n      socket.on(\"leave-room\", (data) => this.handleLeaveRoom(socket, data));\n      socket.on(\"ping\", () => this.handlePing(socket));\n      socket.on(\"disconnect\", () => this.handleDisconnect(socket, userId));\n    });\n  }\n\n  /**\n   * Inicia heartbeat para manter conexÃµes ativas\n   */\n  private startHeartbeat() {\n    this.heartbeatInterval = setInterval(() => {\n      this.io.emit(\"heartbeat\", { timestamp: new Date() });\n    }, 30000); // 30 segundos\n  }\n\n  /**\n   * Handler: UsuÃ¡rio entra em uma sala\n   */\n  private handleJoinRoom(socket: Socket, data: { room: string }) {\n    const { room } = data;\n    const userId = socket.data.userId as number;\n\n    socket.join(room);\n\n    if (!this.rooms.has(room)) {\n      this.rooms.set(room, {\n        name: room,\n        members: new Set(),\n        createdAt: new Date(),\n      });\n    }\n\n    this.rooms.get(room)!.members.add(socket.id);\n\n    this.logger.info(\n      `ðŸ”— UsuÃ¡rio ${userId} entrou na sala ${room} (socket: ${socket.id})`\n    );\n\n    socket.emit(\"joined-room\", { room, timestamp: new Date() });\n    this.io.to(room).emit(\"user-joined\", {\n      userId,\n      socketId: socket.id,\n      room,\n      timestamp: new Date(),\n    });\n  }\n\n  /**\n   * Handler: UsuÃ¡rio sai de uma sala\n   */\n  private handleLeaveRoom(socket: Socket, data: { room: string }) {\n    const { room } = data;\n    const userId = socket.data.userId as number;\n\n    socket.leave(room);\n\n    const roomInfo = this.rooms.get(room);\n    if (roomInfo) {\n      roomInfo.members.delete(socket.id);\n      if (roomInfo.members.size === 0) {\n        this.rooms.delete(room);\n      }\n    }\n\n    this.logger.info(\n      `ðŸ”“ UsuÃ¡rio ${userId} saiu da sala ${room} (socket: ${socket.id})`\n    );\n\n    socket.emit(\"left-room\", { room, timestamp: new Date() });\n    this.io.to(room).emit(\"user-left\", {\n      userId,\n      socketId: socket.id,\n      room,\n      timestamp: new Date(),\n    });\n  }\n\n  /**\n   * Handler: Ping para manter conexÃ£o ativa\n   */\n  private handlePing(socket: Socket) {\n    socket.emit(\"pong\", { timestamp: new Date() });\n  }\n\n  /**\n   * Handler: DesconexÃ£o\n   */\n  private handleDisconnect(socket: Socket, userId: number) {\n    this.logger.info(`âŒ Cliente desconectado: ${socket.id} (usuÃ¡rio: ${userId})`);\n\n    // Remover socket do usuÃ¡rio\n    const userSocketSet = this.userSockets.get(userId);\n    if (userSocketSet) {\n      userSocketSet.delete(socket.id);\n      if (userSocketSet.size === 0) {\n        this.userSockets.delete(userId);\n      }\n    }\n\n    this.socketUsers.delete(socket.id);\n  }\n\n  /**\n   * Emite um evento para um usuÃ¡rio especÃ­fico\n   */\n  emitToUser(userId: number, event: string, data: any) {\n    const room = `user-${userId}`;\n    this.io.to(room).emit(event, data);\n    this.logger.info(`ðŸ“¨ Evento '${event}' enviado para usuÃ¡rio ${userId}`);\n  }\n\n  /**\n   * Emite um evento para uma sala especÃ­fica\n   */\n  emitToRoom(room: string, event: string, data: any) {\n    this.io.to(room).emit(event, data);\n    this.logger.info(`ðŸ“¨ Evento '${event}' enviado para sala ${room}`);\n  }\n\n  /**\n   * Emite um evento para um socket especÃ­fico\n   */\n  emitToSocket(socketId: string, event: string, data: any) {\n    this.io.to(socketId).emit(event, data);\n    this.logger.info(`ðŸ“¨ Evento '${event}' enviado para socket ${socketId}`);\n  }\n\n  /**\n   * Broadcast para todos os clientes\n   */\n  broadcast(event: string, data: any) {\n    this.io.emit(event, data);\n    this.logger.info(`ðŸ“¢ Broadcast: ${event}`);\n  }\n\n  /**\n   * Emite evento de nova mensagem\n   */\n  emitNewMessage(\n    recipientUserId: number,\n    messageData: {\n      id: number;\n      senderId: number;\n      senderName: string;\n      vehiclePlate: string;\n      message: string;\n      type: \"fixed\" | \"custom\";\n      timestamp: Date;\n    }\n  ) {\n    this.emitToUser(recipientUserId, \"new-message\", {\n      ...messageData,\n      receivedAt: new Date(),\n    });\n  }\n\n  /**\n   * Emite evento de reaÃ§Ã£o em mensagem\n   */\n  emitMessageReaction(\n    messageId: number,\n    reactionData: {\n      userId: number;\n      userName: string;\n      reaction: string;\n      timestamp: Date;\n    }\n  ) {\n    this.broadcast(\"message-reaction\", {\n      messageId,\n      ...reactionData,\n    });\n  }\n\n  /**\n   * Emite evento de status de WhatsApp\n   */\n  emitWhatsAppStatus(\n    phoneNumber: string,\n    status: \"connected\" | \"disconnected\" | \"error\"\n  ) {\n    this.broadcast(\"whatsapp-status\", {\n      phoneNumber,\n      status,\n      timestamp: new Date(),\n    });\n  }\n\n  /**\n   * Emite evento de mensagem WhatsApp enviada\n   */\n  emitWhatsAppMessageSent(\n    messageData: {\n      senderPhone: string;\n      recipientPhone: string;\n      message: string;\n      messageId: string;\n      timestamp: Date;\n    }\n  ) {\n    this.broadcast(\"whatsapp-message-sent\", messageData);\n  }\n\n  /**\n   * Emite evento de alerta enviado\n   */\n  emitAlertSent(\n    alertData: {\n      id: number;\n      vehicleId: number;\n      vehiclePlate: string;\n      senderId: number;\n      senderName: string;\n      type: \"fixed\" | \"custom\";\n      message: string;\n      timestamp: Date;\n    }\n  ) {\n    this.broadcast(\"alert-sent\", alertData);\n  }\n\n  /**\n   * Emite evento de notificaÃ§Ã£o push\n   */\n  emitPushNotification(\n    userId: number,\n    notificationData: {\n      title: string;\n      body: string;\n      data?: any;\n      timestamp: Date;\n    }\n  ) {\n    this.emitToUser(userId, \"push-notification\", notificationData);\n  }\n\n  /**\n   * Emite evento de crÃ©ditos atualizados\n   */\n  emitCreditsUpdated(\n    userId: number,\n    creditsData: {\n      newBalance: number;\n      change: number;\n      reason: string;\n      timestamp: Date;\n    }\n  ) {\n    this.emitToUser(userId, \"credits-updated\", creditsData);\n  }\n\n  /**\n   * ObtÃ©m informaÃ§Ãµes de conexÃ£o\n   */\n  getConnectionStats() {\n    return {\n      totalConnectedClients: this.io.sockets.sockets.size,\n      totalUsers: this.userSockets.size,\n      totalRooms: this.rooms.size,\n      rooms: Array.from(this.rooms.keys()),\n      timestamp: new Date(),\n    };\n  }\n\n  /**\n   * ObtÃ©m sockets de um usuÃ¡rio\n   */\n  getUserSockets(userId: number): string[] {\n    const sockets = this.userSockets.get(userId);\n    return sockets ? Array.from(sockets) : [];\n  }\n\n  /**\n   * ObtÃ©m usuÃ¡rio de um socket\n   */\n  getSocketUser(socketId: string): number | undefined {\n    return this.socketUsers.get(socketId);\n  }\n\n  /**\n   * Verifica se um usuÃ¡rio estÃ¡ conectado\n   */\n  isUserConnected(userId: number): boolean {\n    const sockets = this.userSockets.get(userId);\n    return sockets ? sockets.size > 0 : false;\n  }\n\n  /**\n   * Limpa recursos\n   */\n  destroy() {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n    this.io.close();\n    this.logger.info(\"ðŸ›‘ WebSocket Server destruÃ­do\");\n  }\n}\n\n// Singleton\nlet wsServer: WebSocketServer;\n\nexport function initializeWebSocketServer(httpServer: HTTPServer): WebSocketServer {\n  if (!wsServer) {\n    wsServer = new WebSocketServer(httpServer);\n  }\n  return wsServer;\n}\n\nexport function getWebSocketServer(): WebSocketServer {\n  if (!wsServer) {\n    throw new Error(\"WebSocket Server nÃ£o foi inicializado\");\n  }\n  return wsServer;\n}\n
