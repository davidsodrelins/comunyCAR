# Guia de Deployment - comunyCAR\n\n## üìã √çndice\n\n1. [Pr√©-requisitos](#pr√©-requisitos)\n2. [Setup do Servidor](#setup-do-servidor)\n3. [Instala√ß√£o do Banco de Dados](#instala√ß√£o-do-banco-de-dados)\n4. [Deploy do Backend](#deploy-do-backend)\n5. [Deploy do Frontend](#deploy-do-frontend)\n6. [Configura√ß√£o do Nginx](#configura√ß√£o-do-nginx)\n7. [SSL/HTTPS](#ssl-https)\n8. [Monitoramento](#monitoramento)\n9. [Troubleshooting](#troubleshooting)\n\n---\n\n## üîß Pr√©-requisitos\n\n- Ubuntu 20.04 LTS ou superior\n- 2GB RAM m√≠nimo\n- 20GB espa√ßo em disco\n- Acesso SSH ao servidor\n- Dom√≠nio configurado\n\n---\n\n## üñ•Ô∏è Setup do Servidor\n\n### 1. Atualizar Sistema\n\n```bash\nsudo apt update\nsudo apt upgrade -y\n```\n\n### 2. Instalar Node.js\n\n```bash\ncurl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -\nsudo apt install -y nodejs\nnode --version\nnpm --version\n```\n\n### 3. Instalar pnpm\n\n```bash\nnpm install -g pnpm\npnpm --version\n```\n\n### 4. Instalar Git\n\n```bash\nsudo apt install -y git\ngit --version\n```\n\n### 5. Instalar PM2 (Process Manager)\n\n```bash\nsudo npm install -g pm2\npm2 --version\n```\n\n---\n\n## üóÑÔ∏è Instala√ß√£o do Banco de Dados\n\n### 1. Instalar MySQL\n\n```bash\nsudo apt install -y mysql-server\nsudo mysql_secure_installation\n```\n\n### 2. Criar Banco de Dados\n\n```bash\nsudo mysql -u root -p\n```\n\n```sql\nCREATE DATABASE comunycar;\nCREATE USER 'comunycar'@'localhost' IDENTIFIED BY 'senha-segura';\nGRANT ALL PRIVILEGES ON comunycar.* TO 'comunycar'@'localhost';\nFLUSH PRIVILEGES;\nEXIT;\n```\n\n### 3. Verificar Conex√£o\n\n```bash\nmysql -u comunycar -p -h localhost\nSHOW DATABASES;\nEXIT;\n```\n\n---\n\n## üöÄ Deploy do Backend\n\n### 1. Clonar Reposit√≥rio\n\n```bash\ncd /var/www\nsudo git clone https://github.com/davidsodrelins/comunyCAR.git\ncd comunyCAR\nsudo chown -R $USER:$USER .\n```\n\n### 2. Instalar Depend√™ncias\n\n```bash\npnpm install\n```\n\n### 3. Configurar Vari√°veis de Ambiente\n\n```bash\ncp .env.example .env.local\nnano .env.local\n```\n\nAdicionar:\n\n```env\nDATABASE_URL=mysql://comunycar:senha-segura@localhost:3306/comunycar\nJWT_SECRET=seu-secret-muito-seguro-aqui\nNODE_ENV=production\nPORT=3000\n\n# Email\nSMTP_HOST=smtp.gmail.com\nSMTP_PORT=587\nSMTP_USER=seu-email@gmail.com\nSMTP_PASS=sua-senha-app\n\n# Firebase\nFIREBASE_PROJECT_ID=seu-projeto\nFIREBASE_PRIVATE_KEY=sua-chave\nFIREBASE_CLIENT_EMAIL=seu-email@firebase.gserviceaccount.com\n\n# PayPal\nPAYPAL_CLIENT_ID=seu-client-id\nPAYPAL_CLIENT_SECRET=seu-secret\nPAYPAL_MODE=sandbox\n```\n\n### 4. Migrar Banco de Dados\n\n```bash\npnpm db:push\n```\n\n### 5. Build\n\n```bash\npnpm build\n```\n\n### 6. Iniciar com PM2\n\n```bash\npm2 start \"pnpm start\" --name \"comunycar-backend\"\npm2 save\npm2 startup\n```\n\n### 7. Verificar Status\n\n```bash\npm2 status\npm2 logs comunycar-backend\n```\n\n---\n\n## üé® Deploy do Frontend\n\n### 1. Build\n\n```bash\ncd /var/www/comunyCAR/client\nnpm install\nnpm run build\n```\n\n### 2. Servir com Nginx (pr√≥ximo passo)\n\n---\n\n## üåê Configura√ß√£o do Nginx\n\n### 1. Instalar Nginx\n\n```bash\nsudo apt install -y nginx\nsudo systemctl start nginx\nsudo systemctl enable nginx\n```\n\n### 2. Criar Configura√ß√£o\n\n```bash\nsudo nano /etc/nginx/sites-available/comunycar\n```\n\nAdicionar:\n\n```nginx\nupstream backend {\n    server localhost:3000;\n}\n\nserver {\n    listen 80;\n    server_name comunicar.hidalgo.digital;\n\n    # Frontend\n    location / {\n        root /var/www/comunyCAR/client/dist;\n        try_files $uri $uri/ /index.html;\n    }\n\n    # API\n    location /api/ {\n        proxy_pass http://backend/api/;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n\n    # Gzip\n    gzip on;\n    gzip_types text/plain text/css text/javascript application/json application/javascript;\n}\n```\n\n### 3. Ativar Configura√ß√£o\n\n```bash\nsudo ln -s /etc/nginx/sites-available/comunycar /etc/nginx/sites-enabled/\nsudo nginx -t\nsudo systemctl restart nginx\n```\n\n---\n\n## üîí SSL/HTTPS\n\n### 1. Instalar Certbot\n\n```bash\nsudo apt install -y certbot python3-certbot-nginx\n```\n\n### 2. Gerar Certificado\n\n```bash\nsudo certbot certonly --nginx -d comunicar.hidalgo.digital\n```\n\n### 3. Atualizar Nginx\n\n```bash\nsudo nano /etc/nginx/sites-available/comunycar\n```\n\nAdicionar:\n\n```nginx\nserver {\n    listen 443 ssl http2;\n    server_name comunicar.hidalgo.digital;\n\n    ssl_certificate /etc/letsencrypt/live/comunicar.hidalgo.digital/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/comunicar.hidalgo.digital/privkey.pem;\n\n    # ... resto da configura√ß√£o\n}\n\nserver {\n    listen 80;\n    server_name comunicar.hidalgo.digital;\n    return 301 https://$server_name$request_uri;\n}\n```\n\n### 4. Renova√ß√£o Autom√°tica\n\n```bash\nsudo systemctl enable certbot.timer\nsudo systemctl start certbot.timer\n```\n\n---\n\n## üìä Monitoramento\n\n### 1. Verificar Logs\n\n```bash\n# Backend\npm2 logs comunycar-backend\n\n# Nginx\nsudo tail -f /var/log/nginx/access.log\nsudo tail -f /var/log/nginx/error.log\n\n# MySQL\nsudo tail -f /var/log/mysql/error.log\n```\n\n### 2. Monitorar Recursos\n\n```bash\n# CPU e Mem√≥ria\ntop\n\n# Espa√ßo em Disco\ndf -h\n\n# Processos Node.js\npm2 monit\n```\n\n### 3. Backup Autom√°tico\n\n```bash\n# Criar script de backup\nsudo nano /usr/local/bin/backup-comunycar.sh\n```\n\n```bash\n#!/bin/bash\nBACKUP_DIR=\"/backups/comunycar\"\nDATE=$(date +%Y%m%d_%H%M%S)\n\nmkdir -p $BACKUP_DIR\n\n# Backup do banco de dados\nmysqldump -u comunycar -p'senha' comunycar > $BACKUP_DIR/db_$DATE.sql\n\n# Backup dos arquivos\ntar -czf $BACKUP_DIR/files_$DATE.tar.gz /var/www/comunyCAR\n\n# Manter apenas √∫ltimos 7 dias\nfind $BACKUP_DIR -type f -mtime +7 -delete\n```\n\n```bash\nsudo chmod +x /usr/local/bin/backup-comunycar.sh\n```\n\nAdicionar ao crontab:\n\n```bash\nsudo crontab -e\n```\n\n```\n0 2 * * * /usr/local/bin/backup-comunycar.sh\n```\n\n---\n\n## üîß Troubleshooting\n\n### Erro: \"Connection refused\"\n\n```bash\n# Verificar se backend est√° rodando\npm2 status\npm2 restart comunycar-backend\n\n# Verificar porta 3000\nsudo netstat -tlnp | grep 3000\n```\n\n### Erro: \"Database connection failed\"\n\n```bash\n# Verificar MySQL\nsudo systemctl status mysql\n\n# Testar conex√£o\nmysql -u comunycar -p -h localhost\n\n# Verificar DATABASE_URL em .env.local\n```\n\n### Erro: \"SSL certificate not found\"\n\n```bash\n# Renovar certificado\nsudo certbot renew --force-renewal\n\n# Verificar certificados\nsudo certbot certificates\n```\n\n### Erro: \"502 Bad Gateway\"\n\n```bash\n# Verificar logs do Nginx\nsudo tail -f /var/log/nginx/error.log\n\n# Verificar backend\npm2 logs comunycar-backend\n\n# Reiniciar Nginx\nsudo systemctl restart nginx\n```\n\n---\n\n## ‚úÖ Checklist de Deployment\n\n- [ ] Servidor Ubuntu atualizado\n- [ ] Node.js e pnpm instalados\n- [ ] MySQL configurado\n- [ ] Banco de dados criado\n- [ ] Reposit√≥rio clonado\n- [ ] Vari√°veis de ambiente configuradas\n- [ ] Migra√ß√µes executadas\n- [ ] Backend rodando com PM2\n- [ ] Frontend buildado\n- [ ] Nginx configurado\n- [ ] SSL/HTTPS ativo\n- [ ] Backups autom√°ticos configurados\n- [ ] Monitoramento ativo\n\n---\n\n## üìû Suporte\n\nPara problemas com deployment:\n\n1. Verificar logs: `pm2 logs` e `sudo tail -f /var/log/nginx/error.log`\n2. Verificar conectividade: `curl http://localhost:3000`\n3. Verificar banco de dados: `mysql -u comunycar -p`\n4. Criar issue no GitHub com logs\n\n---\n\n**√öltima atualiza√ß√£o:** 2024\n**Vers√£o:** 1.0.0\n
